<!doctype html>
<html>

<head>
  <title>Artist Facing Screen</title>
  <style>
    * {
      margin: 0;
      padding: 0;
    }

    body {
      font: 200px Helvetica, Arial;
      overflow: hidden;
      text-align: center;
    }
  </style>
</head>
<script src="/socket.io/socket.io.js"></script>
<script>
  // For non-polled communication to the backend
  var socket = io();
  // State of what should be displayed how
  var state = {
    mode: 'clock',
    text: '[Connecting to Socket.IO ...]'
  }

  // Generate the clock/countdown string
  function timeString() {
    if (state.mode === 'clock') {
      var now = new Date();
      var hours = now.getHours();
      if (hours < 10) hours = "0" + hours;
      var minutes = now.getMinutes();
      if (minutes < 10) minutes = "0" + minutes;
      var seconds = now.getSeconds();
      if (seconds < 10) seconds = "0" + seconds;
      return '<b>' + hours + ":" + minutes + ":" + seconds + '</b><br />';
    } else if (state.mode === 'countdown') {
      return '<b>' + '01:00:00' + '</b><br />';
    } else {
      return '';
    }
  }

  // Update the text to be displayed with the current clock/countdown + message
  function updateText() {
    document.body.innerHTML = timeString() + state.text;
  }

  // Determine if the current text would fit on the screen with given fontSize
  function fitsTextIntoScreen(fontSize) {
    document.body.style.fontSize = fontSize + 'px';
    if ((document.body.scrollWidth <= window.innerWidth) &&
      (document.body.scrollHeight <= window.innerHeight)) {
      console.log('fitsTextIntoScreen: Tried ' + fontSize + ' fits: TRUE');
      return true;
    } else {
      console.log('fitsTextIntoScreen: Tried ' + fontSize + ' fits: FALSE');
      return false;
    }
  }

  // Find the optimal font size that is as large as possible while still
  // fitting all text without scrolling
  // Google Chrome is a bit slow when trying linearly, so we do the
  // "Binary Search" approach here
  function resizeFont() {
    var upperLimit = 10000;
    var lowerLimit = 0;
    var currentTry = Math.floor((upperLimit + lowerLimit) / 2);

    while (true) {
      // This is what we want: The text fits with that size
      // but would not fit with size + 1
      if (fitsTextIntoScreen(currentTry) && !fitsTextIntoScreen(currentTry+1)) {
        break;
      }

      if (fitsTextIntoScreen(currentTry)) {
        // Text is too small: Set the lowerLimit to currentTry
        lowerLimit = currentTry + 1;
      } else {
        // Text is too large: Set the upperLimit to currentTry
        upperLimit = currentTry - 1;
      }
      currentTry = Math.floor((upperLimit + lowerLimit) / 2);
    }

    document.body.style.fontSize = currentTry + 'px';
  }

  // When a new command comes is, handle that
  socket.on('update', (newState) => {
    state = newState;
    console.log(state);
    updateText();
    resizeFont();
  });

  // Initial updates with a timeout so the DOM has loaded
  window.setTimeout(updateText, 10);
  window.setTimeout(resizeFont, 100);

  // Automatically refresh the clock/countdown every 200ms
  window.setInterval(updateText, 200);

  // Update the font size when the window size changes
  window.onresize = resizeFont;
</script>

<body>
</body>

</html>